#cloud-config
# Cloud-init configuration for VPC/Cloud VM setup
# Use this with AWS EC2, GCP Compute Engine, Azure VMs, DigitalOcean, etc.
#
# Usage:
#   AWS EC2: Pass this file as user-data when launching instance
#   GCP: Use as startup script metadata
#   Azure: Use as custom data
#   DigitalOcean: Add as user data

package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - sudo
  - build-essential

# Create a developer user (adjust as needed)
users:
  - name: developer
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      # Add your SSH public key here
      - ssh-rsa AAAAB3NzaC1yc2E... your-key-here

# Run commands on first boot
runcmd:
  # Install Determinate Nix for the developer user
  - su - developer -c 'curl --proto "=https" --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm'

  # Clone the dotfiles repository (adjust the URL)
  - su - developer -c 'git clone https://github.com/YOUR_USERNAME/nix-dotfiles.git ~/nix-dotfiles'

  # Source Nix environment
  - su - developer -c 'source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'

  # Install Home Manager and apply configuration
  - su - developer -c 'cd ~/nix-dotfiles && /nix/var/nix/profiles/default/bin/nix run home-manager -- switch --flake .#user@linux'

  # Install pre-commit hooks
  - su - developer -c 'cd ~/nix-dotfiles && /home/developer/.nix-profile/bin/pre-commit install'

  # Install Claude Code
  - su - developer -c '/home/developer/.nix-profile/bin/npm install -g @anthropic-ai/claude-code'

# Write configuration files
write_files:
  - path: /etc/profile.d/nix.sh
    content: |
      if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
        . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
      fi
    permissions: '0644'

# Final message
final_message: |
  Cloud VM setup complete!

  Nix + Home Manager environment is ready.

  To connect:
    ssh developer@<vm-ip-address>

  The environment includes:
    - Zsh with customizations
    - Neovim, Tmux, Git, Docker
    - Development tools (Node.js, Python, Rust, Go)
    - Claude Code CLI

  Configuration location: ~/nix-dotfiles
